<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - Rewards</title>
  <style>
    body{margin:0;background:#f0f2f5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#333}
    header{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:14px 22px;border-bottom:1px solid #eaeaea;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .logo{height:36px}
    .container{max-width:1300px;margin:28px auto;padding:0 16px}
    .card{background:#fff;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:20px;margin-bottom:20px}
    h2{margin:0 0 12px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #eee;padding:8px;text-align:left}
    thead{background:#f8f9fa}
    .btn{padding:6px 12px;border:none;border-radius:6px;font-weight:600;color:#fff;cursor:pointer}
    .btn-approve{background:#28a745}
    .btn-reject{background:#dc3545}
    .btn-logout{background:#6c757d}
    .btn-edit{background:#007bff}
    .btn-danger{background:#dc3545}
    .btn-secondary{background:#6c757d}
    .stats{display:flex;gap:20px;margin-bottom:20px}
    .stat-box{flex:1;background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.05);text-align:center}
    .stat-num{font-size:1.8rem;font-weight:700;color:#007bff}
    input[type="number"]{width:100px}
    .row{display:flex;gap:10px;align-items:center}
    textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc}
  </style>
</head>
<body>
  <header>
    <div><img src="logo.png" class="logo"/> <strong>Admin Dashboard</strong></div>
    <button class="btn btn-logout" id="logoutBtn">Logout</button>
  </header>

  <div class="container">

    <!-- Stats -->
    <div class="stats">
      <div class="stat-box">
        <div>Total Users</div>
        <div id="statUsers" class="stat-num">0</div>
      </div>
      <div class="stat-box">
        <div>Total Bill Amount</div>
        <div id="statAmount" class="stat-num">‚Çπ0</div>
      </div>
      <div class="stat-box">
        <div>Total Points Awarded</div>
        <div id="statPoints" class="stat-num">0</div>
      </div>
    </div>

    <!-- Admin Profile & Manage Admins -->
    <div class="card">
      <h2>üë§ Admin Profile</h2>
      <div class="row">
        <strong id="adminEmail">email</strong>
        <button class="btn btn-secondary" id="resetAdminPwd">Send Password Reset</button>
      </div>
      <div id="adminMsg" style="margin-top:8px;"></div>
      <hr/>
      <h3>üõ°Ô∏è Manage Admins</h3>
      <div class="row">
        <input id="newAdminEmail" placeholder="User email to grant admin" style="flex:1;padding:8px;border:1px solid #ccc;border-radius:6px"/>
        <button class="btn btn-edit" id="grantAdminBtn">Grant Admin</button>
        <button class="btn btn-danger" id="revokeAdminBtn">Revoke Admin</button>
      </div>
      <small>Note: this sets the <code>role</code> field in <code>users/{uid}</code>.</small>
      <div id="adminRoleMsg" style="margin-top:8px;"></div>
    </div>

    <!-- Pending Inbox -->
    <div class="card">
      <h2>üì© Pending Requests (Bill Not Found)</h2>
      <table>
        <thead><tr><th>Bill #</th><th>Amount</th><th>User</th><th>Date</th><th>Action</th></tr></thead>
        <tbody id="inboxTable"></tbody>
      </table>
    </div>

    <!-- Add Bill Manually -->
    <div class="card">
      <h2>‚ûï Add Bill</h2>
      <div class="row">
        <input id="addBillNo" placeholder="Bill No (unique)" style="padding:8px;border:1px solid #ccc;border-radius:6px"/>
        <input id="addBillAmount" type="number" placeholder="Amount ‚Çπ" style="padding:8px;border:1px solid #ccc;border-radius:6px"/>
        <button class="btn btn-approve" id="addBillBtn">Add</button>
      </div>
      <div id="addBillMsg" style="margin-top:8px;"></div>
    </div>

    <!-- All Bills -->
    <div class="card">
      <h2>üßæ Bills Database</h2>
      <table>
        <thead><tr><th>Bill #</th><th>Amount (‚Çπ)</th><th>Status</th><th>Claimed By</th><th>Date</th><th>Action</th></tr></thead>
        <tbody id="billsTable"></tbody>
      </table>
    </div>

    <!-- Users -->
    <div class="card">
      <h2>üë• Users</h2>
      <table>
        <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Points</th></tr></thead>
        <tbody id="usersTable"></tbody>
      </table>
    </div>

    <!-- Notifications -->
    <div class="card">
      <h2>üîî Send Notification</h2>
      <textarea id="notifMessage" placeholder="Write your message here..." rows="3"></textarea>
      <br/><br/>
      <button class="btn btn-approve" id="sendNotifBtn">Send</button>
      <div id="notifMsg" style="margin-top:8px;"></div>

      <h3>üì¢ Sent Notifications</h3>
      <ul id="notifList"></ul>
    </div>
  </div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // ===== Init
    const firebaseConfig = {
  apiKey: "AIzaSyCAcVmMBM5cuXmydgj3LpunqXgjPVWW2SI",
  authDomain: "reward-20359.firebaseapp.com",
  projectId: "reward-20359",
  storageBucket: "reward-20359.firebasestorage.app",
  messagingSenderId: "577324459963",
  appId: "1:577324459963:web:d969522318bcb229ae869e",
  measurementId: "G-TX647FT78R"
};
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // ===== Helpers
    async function currentUserIsAdmin(uid){
      const s = await db.collection('users').doc(uid).get();
      return s.exists && s.data().role === 'admin';
    }

    // ===== Guard
    auth.onAuthStateChanged(async (user)=>{
      if(!user){ location.href = 'index.html'; return; }
      const isAdmin = await currentUserIsAdmin(user.uid);
      if(!isAdmin){
        alert('Access denied. Admins only.');
        await auth.signOut();
        return;
      }
      adminEmail.textContent = user.email;
      // load streams
      subscribeInbox();
      subscribeBills();
      subscribeUsers();
      subscribeNotifications();
    });

    // ===== Logout
    logoutBtn.onclick = ()=> auth.signOut();

    // ===== Admin profile
    resetAdminPwd.onclick = async ()=>{
      adminMsg.textContent='';
      try{ await auth.sendPasswordResetEmail(auth.currentUser.email);
           adminMsg.style.color='green'; adminMsg.textContent='Reset email sent.'; }
      catch(e){ adminMsg.style.color='red'; adminMsg.textContent = e.message; }
    };

    // ===== Grant/Revoke admin (by email)
    grantAdminBtn.onclick = ()=> setAdminRole(true);
    revokeAdminBtn.onclick = ()=> setAdminRole(false);

    async function setAdminRole(grant){
      adminRoleMsg.textContent='';
      const email = newAdminEmail.value.trim();
      if(!email){ adminRoleMsg.style.color='red'; adminRoleMsg.textContent='Enter email.'; return; }
      try{
        // Find user doc with this email
        const q = await db.collection('users').where('email','==',email).limit(1).get();
        if(q.empty){ throw new Error('User not found in users collection.'); }
        const uid = q.docs[0].id;
        await db.collection('users').doc(uid).set({ role: grant ? 'admin' : 'user' }, { merge:true });
        adminRoleMsg.style.color='green';
        adminRoleMsg.textContent = grant ? 'Admin granted.' : 'Admin revoked.';
      }catch(e){ adminRoleMsg.style.color='red'; adminRoleMsg.textContent = e.message; }
    }

    // ===== Inbox (approve / reject)
    function subscribeInbox(){
      db.collection('admin_inbox').orderBy('createdAt','desc')
        .onSnapshot(snap=>{
          inboxTable.innerHTML='';
          snap.forEach(doc=>{
            const d = doc.data();
            const date = d.createdAt ? d.createdAt.toDate().toLocaleString() : '-';
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${d.billNo}</td>
              <td>‚Çπ${d.amount}</td>
              <td>${d.userEmail}</td>
              <td>${date}</td>
              <td>
                <button class="btn btn-approve">Approve</button>
                <button class="btn btn-reject">Reject</button>
              </td>`;
            tr.querySelector('.btn-approve').onclick = async ()=>{
              // Create/overwrite bill with requested amount
              await db.collection('bills').doc(d.billNo).set({
                billNo: d.billNo,
                amount: Number(d.amount),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              }, { merge:true });
              await db.collection('admin_inbox').doc(doc.id).delete();
            };
            tr.querySelector('.btn-reject').onclick = async ()=>{
              await db.collection('admin_inbox').doc(doc.id).delete();
            };
            inboxTable.appendChild(tr);
          });
        });
    }

    // ===== Add Bill Manually
    addBillBtn.onclick = async ()=>{
      addBillMsg.textContent='';
      const billNo = addBillNo.value.trim();
      const amount = Number(addBillAmount.value);
      if(!billNo || !amount || amount<=0){
        addBillMsg.style.color='red'; addBillMsg.textContent='Enter valid bill no and amount.'; return;
      }
      try{
        await db.collection('bills').doc(billNo).set({
          billNo, amount,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        addBillMsg.style.color='green'; addBillMsg.textContent='Bill added.';
        addBillNo.value=''; addBillAmount.value='';
      }catch(e){ addBillMsg.style.color='red'; addBillMsg.textContent=e.message; }
    };

    // ===== Bills (edit amount -> auto re-calc user points if already claimed)
    function subscribeBills(){
      db.collection('bills').orderBy('createdAt','desc')
        .onSnapshot(snap=>{
          billsTable.innerHTML='';
          let totalAmt = 0;
          snap.forEach(doc=>{
            const d = doc.data();
            totalAmt += d.amount || 0;
            const date = d.createdAt ? d.createdAt.toDate().toLocaleString() : '-';
            const status = d.claimedBy ? "‚úÖ Claimed" : "‚è≥ Available";
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${d.billNo}</td>
              <td>‚Çπ <input type="number" min="0" value="${Number(d.amount||0)}" id="amt-${doc.id}" /></td>
              <td>${status}</td>
              <td>${d.claimedBy || '-'}</td>
              <td>${date}</td>
              <td><button class="btn btn-edit">Update</button></td>`;
            tr.querySelector('.btn-edit').onclick = ()=> updateBillAmount(doc.id, d);
            billsTable.appendChild(tr);
          });
          statAmount.textContent = "‚Çπ" + totalAmt;
        });
    }

    async function updateBillAmount(billId, oldData){
      const input = document.getElementById('amt-'+billId);
      const newAmt = Number(input.value);
      if(isNaN(newAmt) || newAmt<=0){ alert('Enter valid amount'); return; }

      const bRef = db.collection('bills').doc(billId);
      const bSnap = await bRef.get();
      if(!bSnap.exists) return;
      const b = bSnap.data();
      const oldAmt = Number(b.amount||0);

      // If bill is claimed, adjust the user's points to match new amount
      if (b.claimedBy){
        const userId = b.claimedBy;
        const uRef = db.collection('users').doc(userId);

        // Find claim doc for this bill
        const claimSnap = await uRef.collection('claims').where('billNo','==',billId).limit(1).get();
        if (!claimSnap.empty){
          const clDoc = claimSnap.docs[0];
          const cl = clDoc.data();

          const oldPoints = Math.floor(Number(cl.amount||0) * 0.01);
          const desiredPoints = Math.floor(newAmt * 0.01);

          // Prevent extra claim: if user claimed against higher than new bill, reduce; if lower, increase accordingly
          const diff = desiredPoints - oldPoints;

          await db.runTransaction(async (tx)=>{
            const uSnap = await tx.get(uRef);
            const cur = uSnap.exists && uSnap.data().points ? uSnap.data().points : 0;
            tx.update(uRef, { points: cur + diff });

            tx.update(uRef.collection('claims').doc(clDoc.id), {
              amount: newAmt,
              points: desiredPoints,
              editedByAdminAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            tx.update(bRef, { amount: newAmt, editedByAdminAt: firebase.firestore.FieldValue.serverTimestamp() });
          });
          alert('Bill & user points updated.');
        } else {
          // No claim doc found (edge), just update bill amount
          await bRef.update({ amount: newAmt, editedByAdminAt: firebase.firestore.FieldValue.serverTimestamp() });
        }
      } else {
        // Not claimed yet: just update amount
        await bRef.update({ amount: newAmt, editedByAdminAt: firebase.firestore.FieldValue.serverTimestamp() });
      }
    }

    // ===== Users
    function subscribeUsers(){
      db.collection('users').onSnapshot(snap=>{
        usersTable.innerHTML='';
        let totalPts = 0, totalUsers = 0;
        snap.forEach(doc=>{
          const d = doc.data();
          totalPts += d.points || 0;
          totalUsers++;
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${d.name||'-'}</td><td>${d.email}</td><td>${d.phone||'-'}</td><td>${d.points||0}</td>`;
          usersTable.appendChild(tr);
        });
        statUsers.textContent = totalUsers;
        statPoints.textContent = totalPts;
      });
    }

    // ===== Notifications
    sendNotifBtn.onclick = async ()=>{
      notifMsg.textContent='';
      const message = notifMessage.value.trim();
      if(!message){ notifMsg.style.color='red'; notifMsg.textContent='Enter a message.'; return; }
      try{
        await db.collection('notifications').add({
          message,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: auth.currentUser.email
        });
        notifMessage.value='';
        notifMsg.style.color='green'; notifMsg.textContent='Notification sent.';
      }catch(e){ notifMsg.style.color='red'; notifMsg.textContent=e.message; }
    };

    function subscribeNotifications(){
      db.collection('notifications').orderBy('createdAt','desc')
        .onSnapshot(snap=>{
          notifList.innerHTML='';
          snap.forEach(doc=>{
            const d = doc.data();
            const date = d.createdAt ? d.createdAt.toDate().toLocaleString() : '-';
            const li = document.createElement('li');
            li.textContent = `[${date}] ${d.message} (by ${d.createdBy||'-'})`;
            notifList.appendChild(li);
          });
        });
    }
  </script>
</body>
</html>

