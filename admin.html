<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - Rewards</title>
  <style>
    body{margin:0;font-family:Segoe UI,Arial;background:#f0f2f5;color:#333}
    header{background:#4a148c;color:#fff;padding:14px 22px;display:flex;justify-content:space-between;align-items:center}
    header strong{font-size:1.2rem}
    .container{max-width:1200px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:20px}
    .card{background:#fff;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:20px;margin-bottom:20px}
    h2{margin:0 0 12px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #eee;padding:8px;text-align:left;font-size:0.9rem}
    thead{background:#f8f9fa}
    label{display:block;margin-top:10px;font-weight:600}
    input,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;margin-top:4px}
    .btn{margin-top:10px;padding:10px 14px;border:none;border-radius:6px;font-weight:600;color:#fff;cursor:pointer}
    .btn-primary{background:#007bff}
    .btn-green{background:#28a745}
    .btn-red{background:#dc3545}
    .btn-gray{background:#6c757d}
    button:disabled{opacity:0.6;cursor:not-allowed}
    .msg{font-size:0.9rem;margin-top:8px}
    .flex{display:flex;justify-content:space-between;align-items:center}
  </style>
</head>
<body>
  <header>
    <strong>Admin Dashboard</strong>
    <div>
      <span id="adminName">Hi, Admin</span>
      <button class="btn btn-gray" id="logoutBtn">Logout</button>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <!-- Left big column -->
      <div>
        <!-- Users -->
        <div class="card">
          <h2>All Users</h2>
          <table>
            <thead><tr><th>Name</th><th>Email</th><th>Points</th><th>Claims</th></tr></thead>
            <tbody id="usersTable"></tbody>
          </table>
        </div>

        <!-- Bills -->
        <div class="card">
          <h2>Bills</h2>
          <label>Bill No</label><input id="billNo" />
          <label>Amount (₹)</label><input id="billAmt" type="number" />
          <button class="btn btn-green" id="addBillBtn">Add Bill</button>
          <div class="msg" id="billMsg"></div>

          <h3 style="margin-top:20px">Recent Bills</h3>
          <table>
            <thead><tr><th>No</th><th>Amount</th><th>Claimed By</th></tr></thead>
            <tbody id="billsTable"></tbody>
          </table>
        </div>
      </div>

      <!-- Right small column -->
      <div>
        <!-- Notifications -->
        <div class="card">
          <h2>Send Notification</h2>
          <textarea id="notifText" rows="3" placeholder="Message..."></textarea>
          <button class="btn btn-primary" id="sendNotifBtn">Send</button>
          <div class="msg" id="notifMsg"></div>
        </div>

        <!-- Profile -->
        <div class="card">
          <h2>Admin Profile</h2>
          <label>Name</label><input id="aName"/>
          <label>Email (read-only)</label><input id="aEmail" disabled/>
          <button class="btn btn-primary" id="saveAdminBtn">Save</button>
          <button class="btn btn-gray" id="resetPwdBtn">Reset Password</button>
          <div class="msg" id="adminMsg"></div>
        </div>

        <!-- Manage Admins -->
        <div class="card">
          <h2>Manage Admins</h2>
          <label>New Admin UID</label><input id="newAdminUid" placeholder="Paste user UID"/>
          <button class="btn btn-green" id="addAdminBtn">Add Admin</button>
          <label>Remove Admin UID</label><input id="removeAdminUid"/>
          <button class="btn btn-red" id="removeAdminBtn">Remove Admin</button>
          <div class="msg" id="manageAdminMsg"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, updateProfile, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCAcVmMBM5cuXmydgj3LpunqXgjPVWW2SI",
      authDomain: "reward-20359.firebaseapp.com",
      projectId: "reward-20359",
      storageBucket: "reward-20359.firebasestorage.app",
      messagingSenderId: "577324459963",
      appId: "1:577324459963:web:d969522318bcb229ae869e"
    };
    const app=initializeApp(firebaseConfig);
    const auth=getAuth(app);
    const db=getFirestore(app);

    let currentUser=null;

    // ===== Auth guard
    onAuthStateChanged(auth,async(user)=>{
      if(!user){location.href="index.html";return;}
      currentUser=user;
      const snap=await getDoc(doc(db,"users",user.uid));
      if(!snap.exists()||snap.data().role!=="admin"){ alert("Not admin!"); location.href="index.html"; return; }
      adminName.textContent="Hi, "+(snap.data().name||"Admin");
      aName.value=snap.data().name||"";
      aEmail.value=user.email;
      subscribeUsers();
      subscribeBills();
    });

    // ===== Logout
    logoutBtn.onclick=()=>signOut(auth);

    // ===== Users live
    function subscribeUsers(){
      onSnapshot(collection(db,"users"),(snap)=>{
        usersTable.innerHTML="";
        snap.forEach(d=>{
          const u=d.data();
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${u.name||"-"}</td><td>${u.email}</td><td>${u.points||0}</td><td>${(u.claimsCount||0)}</td>`;
          usersTable.appendChild(tr);
        });
      });
    }

    // ===== Bills live
    function subscribeBills(){
      const q=query(collection(db,"bills"),orderBy("createdAt","desc"));
      onSnapshot(q,(snap)=>{
        billsTable.innerHTML="";
        snap.forEach(d=>{
          const b=d.data();
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${d.id}</td><td>₹${b.amount}</td><td>${b.claimedBy||"-"}</td>`;
          billsTable.appendChild(tr);
        });
      });
    }

    // ===== Add Bill
    addBillBtn.onclick=async()=>{
      billMsg.textContent=""; addBillBtn.disabled=true;
      try{
        await setDoc(doc(db,"bills",billNo.value.trim()),{
          amount:Number(billAmt.value),createdAt:new Date()
        });
        billMsg.style.color="green"; billMsg.textContent="Bill added.";
        billNo.value=""; billAmt.value="";
      }catch(e){ billMsg.style.color="red"; billMsg.textContent=e.message; }
      addBillBtn.disabled=false;
    };

    // ===== Send Notification
    sendNotifBtn.onclick=async()=>{
      notifMsg.textContent=""; sendNotifBtn.disabled=true;
      try{
        await setDoc(doc(collection(db,"notifications")),{
          message:notifText.value,createdAt:new Date()
        });
        notifMsg.style.color="green"; notifMsg.textContent="Sent!";
        notifText.value="";
      }catch(e){ notifMsg.style.color="red"; notifMsg.textContent=e.message; }
      sendNotifBtn.disabled=false;
    };

    // ===== Save Admin Profile
    saveAdminBtn.onclick=async()=>{
      adminMsg.textContent=""; saveAdminBtn.disabled=true;
      try{
        await updateProfile(currentUser,{displayName:aName.value});
        await updateDoc(doc(db,"users",currentUser.uid),{name:aName.value});
        adminMsg.style.color="green"; adminMsg.textContent="Saved.";
      }catch(e){ adminMsg.style.color="red"; adminMsg.textContent=e.message; }
      saveAdminBtn.disabled=false;
    };

    // ===== Reset Pwd
    resetPwdBtn.onclick=async()=>{
      adminMsg.textContent=""; resetPwdBtn.disabled=true;
      try{
        await sendPasswordResetEmail(auth,currentUser.email);
        adminMsg.style.color="green"; adminMsg.textContent="Reset email sent!";
      }catch(e){ adminMsg.style.color="red"; adminMsg.textContent=e.message; }
      resetPwdBtn.disabled=false;
    };

    // ===== Manage Admins
    addAdminBtn.onclick=async()=>{
      manageAdminMsg.textContent=""; addAdminBtn.disabled=true;
      try{
        await updateDoc(doc(db,"users",newAdminUid.value.trim()),{role:"admin"});
        manageAdminMsg.style.color="green"; manageAdminMsg.textContent="Admin added.";
        newAdminUid.value="";
      }catch(e){ manageAdminMsg.style.color="red"; manageAdminMsg.textContent=e.message; }
      addAdminBtn.disabled=false;
    };

    removeAdminBtn.onclick=async()=>{
      manageAdminMsg.textContent=""; removeAdminBtn.disabled=true;
      try{
        await updateDoc(doc(db,"users",removeAdminUid.value.trim()),{role:"user"});
        manageAdminMsg.style.color="green"; manageAdminMsg.textContent="Admin removed.";
        removeAdminUid.value="";
      }catch(e){ manageAdminMsg.style.color="red"; manageAdminMsg.textContent=e.message; }
      removeAdminBtn.disabled=false;
    };
  </script>
</body>
</html>
