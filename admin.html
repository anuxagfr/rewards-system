<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <style>
    body {margin:0;background:#f0f2f5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#333}
    header{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:14px 22px;border-bottom:1px solid #eaeaea;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .logo{height:36px}
    h1{font-size:20px;margin:0}
    button{background:#007bff;color:#fff;border:none;padding:6px 12px;margin:4px;border-radius:6px;cursor:pointer}
    button:hover{background:#0056b3}
    .container{padding:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));grid-gap:20px}
    .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .card h2{font-size:18px;margin-top:0}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border:1px solid #ddd;padding:6px;text-align:left}
    th{background:#f8f9fa}
    input{padding:6px;margin:4px;width:95%;border:1px solid #ccc;border-radius:6px}
  </style>
</head>
<body>
  <header>
    <h1>Admin Dashboard</h1>
    <div>
      <span id="adminName"></span>
      <button id="logoutBtn">Logout</button>
    </div>
  </header>

  <div class="container">
    <!-- Stats -->
    <div class="card" id="statsCard">
      <h2>Stats</h2>
      <p>Total Users: <span id="totalUsers">0</span></p>
      <p>Total Bills: <span id="totalBills">0</span></p>
      <p>Total Points: <span id="totalPoints">0</span></p>
    </div>

    <!-- Pending Inbox -->
    <div class="card">
      <h2>Pending Inbox</h2>
      <table>
        <thead><tr><th>User ID</th><th>Bill</th><th>Action</th></tr></thead>
        <tbody id="inboxTable"></tbody>
      </table>
    </div>

    <!-- Bills Database -->
    <div class="card">
      <h2>Bills Database</h2>
      <table>
        <thead><tr><th>User ID</th><th>Amount</th><th>Action</th></tr></thead>
        <tbody id="billsTable"></tbody>
      </table>
      <h3>Add Bill</h3>
      <input id="billUserId" placeholder="User ID">
      <input id="billAmount" type="number" placeholder="Amount">
      <button id="addBillBtn">Add Bill</button>
    </div>

    <!-- Users Database -->
    <div class="card">
      <h2>Users</h2>
      <table>
        <thead><tr><th>Name</th><th>Email</th><th>Points</th></tr></thead>
        <tbody id="usersTable"></tbody>
      </table>
    </div>

    <!-- Profile -->
    <div class="card">
      <h2>Profile</h2>
      <input id="profileName" placeholder="Name">
      <input id="profilePassword" type="password" placeholder="New Password">
      <button id="updateProfileBtn">Update Profile</button>
    </div>

    <!-- Notifications (superadmin only) -->
    <div class="card" id="notificationsCard" style="display:none">
      <h2>Notifications</h2>
      <ul id="notificationsList"></ul>
    </div>

    <!-- Admin Management (superadmin only) -->
    <div class="card" id="adminMgmtCard" style="display:none">
      <h2>Manage Admins</h2>
      <input id="newAdminEmail" placeholder="Admin Email">
      <input id="newAdminPwd" type="password" placeholder="Password">
      <button id="addAdminBtn">Add Admin</button>
      <ul id="adminsList"></ul>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script>
    // TODO: Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_DOMAIN",
      projectId: "YOUR_PROJECT",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Role state
    let currentUser = null;
    let currentRole = null;

    // Auth listener
    auth.onAuthStateChanged(async user => {
      if (!user) {
        location.href = "index.html"; 
        return;
      }
      currentUser = user;
      document.getElementById("adminName").textContent = user.email;

      // Fetch role
      const snap = await db.collection("users").doc(user.uid).get();
      currentRole = snap.exists ? snap.data().role : "admin";

      if (currentRole === "superadmin") {
        document.getElementById("notificationsCard").style.display = "block";
        document.getElementById("adminMgmtCard").style.display = "block";
        subscribeAdmins();
        subscribeNotifications();
      }

      subscribeStats();
      subscribeInbox();
      subscribeBills();
      subscribeUsers();
    });

    // Stats
    function subscribeStats() {
      db.collection("users").onSnapshot(snap => {
        let users = snap.size, points=0;
        snap.forEach(d => { points += d.data().points || 0; });
        document.getElementById("totalUsers").textContent = users;
        document.getElementById("totalPoints").textContent = points;
      });
      db.collection("bills").onSnapshot(snap => {
        document.getElementById("totalBills").textContent = snap.size;
      });
    }

    // Inbox
    function subscribeInbox() {
      db.collection("admin_inbox").onSnapshot(snap => {
        const tbody = document.getElementById("inboxTable");
        tbody.innerHTML="";
        snap.forEach(doc=>{
          const d = doc.data();
          tbody.innerHTML += `<tr>
            <td>${d.userId}</td><td>${d.amount}</td>
            <td><button onclick="approveInbox('${doc.id}','${d.userId}',${d.amount})">Approve</button></td>
          </tr>`;
        });
      });
    }
    async function approveInbox(id,userId,amount){
      await db.collection("bills").add({userId,amount});
      if(userId){
        const ref=db.collection("users").doc(userId);
        await db.runTransaction(async t=>{
          const u=await t.get(ref); if(u.exists){
            const pts=u.data().points||0;
            t.update(ref,{points:pts+Math.floor(amount/100)});
          }
        });
      }
      await db.collection("admin_inbox").doc(id).delete();
    }

    // Bills
    function subscribeBills(){
      db.collection("bills").onSnapshot(snap=>{
        const tbody=document.getElementById("billsTable"); tbody.innerHTML="";
        snap.forEach(doc=>{
          const d=doc.data();
          tbody.innerHTML += `<tr>
            <td>${d.userId}</td><td>${d.amount}</td>
            <td><button onclick="updateBill('${doc.id}','${d.userId}',${d.amount})">Update</button></td>
          </tr>`;
        });
      });
    }
    async function updateBill(id,userId,oldAmt){
      const newAmt=+prompt("New amount:",oldAmt); if(isNaN(newAmt))return;
      await db.collection("bills").doc(id).update({amount:newAmt});
      if(userId){
        const ref=db.collection("users").doc(userId);
        await db.runTransaction(async t=>{
          const u=await t.get(ref); if(u.exists){
            const pts=u.data().points||0;
            const diff=Math.floor(newAmt/100)-Math.floor(oldAmt/100);
            t.update(ref,{points:pts+diff});
          }
        });
      }
    }
    document.getElementById("addBillBtn").onclick=async()=>{
      const uid=document.getElementById("billUserId").value;
      const amt=+document.getElementById("billAmount").value;
      if(!uid||isNaN(amt)) return;
      await db.collection("bills").add({userId:uid,amount:amt});
      const ref=db.collection("users").doc(uid);
      await db.runTransaction(async t=>{
        const u=await t.get(ref); if(u.exists){
          const pts=u.data().points||0;
          t.update(ref,{points:pts+Math.floor(amt/100)});
        }
      });
    };

    // Users
    function subscribeUsers(){
      db.collection("users").onSnapshot(snap=>{
        const tbody=document.getElementById("usersTable"); tbody.innerHTML="";
        snap.forEach(doc=>{
          const d=doc.data();
          tbody.innerHTML += `<tr><td>${d.name||""}</td><td>${d.email||""}</td><td>${d.points||0}</td></tr>`;
        });
      });
    }

    // Profile
    document.getElementById("updateProfileBtn").onclick=async()=>{
      const name=document.getElementById("profileName").value;
      const pwd=document.getElementById("profilePassword").value;
      if(name){ await db.collection("users").doc(currentUser.uid).update({name}); }
      if(pwd){ try{ await currentUser.updatePassword(pwd); alert("Password updated"); }
        catch(e){ alert("Re-login required before changing password"); } }
    };

    // Notifications (superadmin)
    function subscribeNotifications(){
      db.collection("notifications").onSnapshot(snap=>{
        const list=document.getElementById("notificationsList"); list.innerHTML="";
        snap.forEach(doc=>{ list.innerHTML+=`<li>${doc.data().message}</li>`; });
      });
    }

    // Admin Mgmt (superadmin)
    function subscribeAdmins(){
      db.collection("pending_admins").onSnapshot(snap=>{
        const list=document.getElementById("adminsList"); list.innerHTML="";
        snap.forEach(doc=>{
          const d=doc.data();
          list.innerHTML+=`<li>${d.email} <button onclick="removeAdmin('${doc.id}')">Remove</button></li>`;
        });
      });
    }
    document.getElementById("addAdminBtn").onclick=async()=>{
      const email=document.getElementById("newAdminEmail").value;
      const pwd=document.getElementById("newAdminPwd").value;
      if(email&&pwd){
        await db.collection("pending_admins").add({email,pwd,created:Date.now()});
      }
    };
    async function removeAdmin(id){ await db.collection("pending_admins").doc(id).delete(); }

    // Logout
    document.getElementById("logoutBtn").onclick=()=>auth.signOut();
  </script>
</body>
</html>
