<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - Rewards</title>
  <style>
    body{margin:0;font-family:Segoe UI,Arial;background:#f4f6f8;color:#333}
    header{background:#4a148c;color:#fff;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center}
    header h2{margin:0}
    .container{padding:20px;max-width:1200px;margin:auto}
    .stats{display:flex;gap:20px;margin-bottom:20px}
    .card{flex:1;background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,0.05)}
    .card h3{margin:0;font-size:1rem;color:#666}
    .card .value{font-size:1.5rem;font-weight:bold;color:#4a148c;margin-top:10px}
    table{width:100%;border-collapse:collapse;background:#fff;margin-top:20px}
    th,td{border:1px solid #eee;padding:10px;text-align:left}
    th{background:#f9f9f9}
    .btn{padding:8px 12px;border:none;border-radius:6px;cursor:pointer;font-weight:600}
    .btn-primary{background:#4a148c;color:#fff}
    .btn-danger{background:#e53935;color:#fff}
    .btn-green{background:#43a047;color:#fff}
    .section{background:#fff;padding:20px;margin-top:20px;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,0.05)}
    label{display:block;margin-top:10px;font-weight:600}
    input,textarea{width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:6px}
    .logout{background:#e53935;color:#fff;padding:8px 12px;border-radius:6px;cursor:pointer}
  </style>
</head>
<body>
<header>
  <h2>Admin Dashboard</h2>
  <button class="logout" id="logoutBtn">Logout</button>
</header>

<div class="container">

  <!-- Stats -->
  <div class="stats">
    <div class="card"><h3>Total Users</h3><div class="value" id="statUsers">0</div></div>
    <div class="card"><h3>Total Points</h3><div class="value" id="statPoints">0</div></div>
    <div class="card"><h3>Total Bill Amount</h3><div class="value" id="statBills">‚Çπ0</div></div>
  </div>

  <!-- Users Table -->
  <div class="section">
    <h3>üë• Users</h3>
    <table>
      <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Points</th><th>Role</th><th>Actions</th></tr></thead>
      <tbody id="usersTable"></tbody>
    </table>
  </div>

  <!-- Bills -->
  <div class="section">
    <h3>üßæ Manage Bills</h3>
    <label>Bill Number</label>
    <input id="billNo" type="text"/>
    <label>Amount (‚Çπ)</label>
    <input id="billAmount" type="number"/>
    <button class="btn btn-green" id="addBillBtn">Add Bill</button>
    <div id="billMsg"></div>
  </div>

  <!-- Notifications -->
  <div class="section">
    <h3>üîî Send Notification</h3>
    <textarea id="notifMsg" placeholder="Type your message..."></textarea>
    <button class="btn btn-primary" id="sendNotifBtn">Send</button>
    <div id="notifMsgBox"></div>
  </div>

  <!-- Admin Profile -->
  <div class="section">
    <h3>‚öôÔ∏è Admin Profile</h3>
    <label>Name</label><input id="adminName"/>
    <label>Email (readonly)</label><input id="adminEmail" disabled/>
    <label>Change Password</label><button class="btn btn-primary" id="changePwdBtn">Send Reset Email</button>
    <button class="btn btn-green" id="saveAdminBtn">Save Profile</button>
    <div id="adminMsg"></div>
  </div>

  <!-- Manage Admins -->
  <div class="section">
    <h3>üëë Manage Admins</h3>
    <label>User Email</label>
    <input id="adminEmailInput"/>
    <button class="btn btn-primary" id="addAdminBtn">Add Admin</button>
    <button class="btn btn-danger" id="removeAdminBtn">Remove Admin</button>
    <div id="adminRoleMsg"></div>
  </div>

</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, collection, getDocs, setDoc, doc, updateDoc, addDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = { /* üîë your config */ };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Logout
  logoutBtn.onclick = ()=> signOut(auth).then(()=>location.href="index.html");

  // Load stats + users
  async function loadUsers(){
    const snap = await getDocs(collection(db,"users"));
    let totalUsers=0,totalPoints=0;
    usersTable.innerHTML="";
    snap.forEach(d=>{
      const u=d.data(); totalUsers++; totalPoints+=(u.points||0);
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${u.name||""}</td><td>${u.email}</td><td>${u.phone||""}</td><td>${u.points||0}</td><td>${u.role}</td>
      <td>${u.role==="admin"?"":"<button class='btn btn-primary'>Promote</button>"}</td>`;
      usersTable.appendChild(tr);
    });
    statUsers.textContent=totalUsers;
    statPoints.textContent=totalPoints;
  }
  loadUsers();

  // Bills
  addBillBtn.onclick=async()=>{
    try{
      await setDoc(doc(db,"bills",billNo.value),{amount:Number(billAmount.value),createdAt:Date.now()});
      billMsg.textContent="Bill added!";billMsg.style.color="green";
    }catch(e){billMsg.textContent=e.message;billMsg.style.color="red";}
  }

  // Notifications
  sendNotifBtn.onclick=async()=>{
    try{
      await addDoc(collection(db,"notifications"),{message:notifMsg.value,createdAt:new Date()});
      notifMsgBox.textContent="Notification sent.";notifMsgBox.style.color="green";
    }catch(e){notifMsgBox.textContent=e.message;notifMsgBox.style.color="red";}
  }

  // Admin profile
  auth.onAuthStateChanged(async user=>{
    if(!user){location.href="index.html";return;}
    adminEmail.value=user.email;
    const snap=await getDocs(query(collection(db,"users"),where("email","==",user.email)));
    snap.forEach(d=>{adminName.value=d.data().name||"";});
  });

  saveAdminBtn.onclick=async()=>{
    const user=auth.currentUser;
    if(!user)return;
    try{
      await updateDoc(doc(db,"users",user.uid),{name:adminName.value});
      adminMsg.textContent="Profile updated.";adminMsg.style.color="green";
    }catch(e){adminMsg.textContent=e.message;adminMsg.style.color="red";}
  }

  changePwdBtn.onclick=()=> sendPasswordResetEmail(auth,auth.currentUser.email);

  // Manage Admins
  addAdminBtn.onclick=()=> updateRole("admin");
  removeAdminBtn.onclick=()=> updateRole("user");

  async function updateRole(role){
    try{
      const q=query(collection(db,"users"),where("email","==",adminEmailInput.value));
      const snap=await getDocs(q);
      if(snap.empty){adminRoleMsg.textContent="User not found.";return;}
      snap.forEach(async d=>{
        await updateDoc(doc(db,"users",d.id),{role});
        adminRoleMsg.textContent=`Role updated to ${role}`;
        adminRoleMsg.style.color="green"; loadUsers();
      });
    }catch(e){adminRoleMsg.textContent=e.message;adminRoleMsg.style.color="red";}
  }

</script>
</body>
</html>
