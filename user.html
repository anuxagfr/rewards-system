<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Dashboard - Rewards</title>
  <style>
    body{margin:0;background:#f0f2f5;font-family:Segoe UI,Arial;color:#333}
    header{display:flex;justify-content:space-between;align-items:center;background:#4a148c;color:#fff;padding:14px 22px}
    .logo{height:36px}
    .container{max-width:1100px;margin:28px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:22px}
    .card{background:#fff;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:20px}
    h2{margin:0 0 12px}
    .balance{font-size:2.2rem;font-weight:800;color:#007bff}
    .tabs{display:flex;gap:10px;margin-bottom:14px}
    .tab{padding:8px 12px;border-radius:999px;background:#e9ecef;cursor:pointer;font-weight:600}
    .tab.active{background:#007bff;color:#fff}
    .hidden{display:none}
    label{display:block;margin-top:12px;font-weight:600}
    input{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;margin-top:6px}
    .btn{margin-top:14px;padding:12px 16px;border:none;border-radius:8px;font-weight:700;color:#fff;cursor:pointer}
    .btn-primary{background:#007bff}
    .btn-green{background:#28a745}
    .btn-gray{background:#6c757d}
    .row{display:flex;gap:10px;align-items:center}
    .msg{margin-top:8px;min-height:20px}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{border:1px solid #eee;padding:10px;text-align:left}
    thead{background:#f8f9fa}
    .topbar{display:flex;gap:12px;align-items:center}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    button:disabled{opacity:0.6;cursor:not-allowed}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <img src="logo.png" class="logo" alt="Shakuntlam"/>
      <strong>User Dashboard</strong>
    </div>
    <div class="topbar">
      <span id="helloName">Hi, User</span>
      <button class="btn btn-gray" id="logoutBtn">Logout</button>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <!-- Left -->
      <div class="card">
        <h2>Points Balance</h2>
        <div class="balance" id="pointsBalance">0</div>

        <div class="tabs">
          <div class="tab active" data-tab="claim">Claim Points</div>
          <div class="tab" data-tab="profile">Profile</div>
        </div>

        <!-- Claim Points -->
        <div id="tab-claim">
          <label>Bill Number</label>
          <input id="billNo" type="text" placeholder="e.g. INV-12345" />
          <label>Bill Amount (â‚¹)</label>
          <input id="billAmount" type="number" min="0" />
          <button class="btn btn-green" id="claimBtn">Claim 1% Points</button>
          <div class="msg" id="claimMsg"></div>

          <h3 style="margin-top:22px">My Claims</h3>
          <table>
            <thead><tr><th>Bill #</th><th>Amount</th><th>Points</th><th>Date</th></tr></thead>
            <tbody id="claimsTable"></tbody>
          </table>
        </div>

        <!-- Profile -->
        <div id="tab-profile" class="hidden">
          <label>Full Name</label>
          <input id="pName" type="text"/>
          <label>Email (read-only)</label>
          <input id="pEmail" type="email" disabled/>
          <label>Phone</label>
          <input id="pPhone" type="tel"/>

          <div class="row">
            <button class="btn btn-primary" id="saveProfileBtn">Save Profile</button>
            <button class="btn btn-gray" id="changePwdBtn">Change Password</button>
          </div>
          <div class="msg" id="profileMsg"></div>
        </div>
      </div>

      <!-- Right -->
      <div class="card">
        <h2>ðŸ”” Notifications</h2>
        <ul id="userNotifList"></ul>
      </div>
    </div>
  </div>

  <!-- Firebase v10 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, updateProfile, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, query, orderBy, onSnapshot, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCAcVmMBM5cuXmydgj3LpunqXgjPVWW2SI",
      authDomain: "reward-20359.firebaseapp.com",
      projectId: "reward-20359",
      storageBucket: "reward-20359.firebasestorage.app",
      messagingSenderId: "577324459963",
      appId: "1:577324459963:web:d969522318bcb229ae869e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser=null;

    // ===== Auth guard
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="index.html"; return; }
      currentUser=user;
      helloName.textContent = "Hi, " + (user.displayName || "User");
      loadProfileAndPoints(user.uid);
      subscribeClaims(user.uid);
      subscribeNotifications();
    });

    // ===== Tabs
    document.querySelectorAll('.tab').forEach(t=>{
      t.onclick=()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        document.getElementById('tab-claim').classList.toggle('hidden', t.dataset.tab!=="claim");
        document.getElementById('tab-profile').classList.toggle('hidden', t.dataset.tab!=="profile");
      }
    });

    // ===== Load Profile + Points
    async function loadProfileAndPoints(uid){
      const snap=await getDoc(doc(db,"users",uid));
      const data=snap.exists()?snap.data():{name:"",email:currentUser.email,phone:"",points:0};
      pointsBalance.textContent=data.points||0;
      pName.value=data.name||"";
      pEmail.value=data.email||currentUser.email;
      pPhone.value=data.phone||"";
    }

    // ===== Save Profile
    saveProfileBtn.onclick=async ()=>{
      profileMsg.textContent="";
      saveProfileBtn.disabled=true;
      try{
        const name=pName.value.trim();
        const phone=pPhone.value.trim();
        await updateProfile(currentUser,{displayName:name});
        await setDoc(doc(db,"users",currentUser.uid),{
          name,email:currentUser.email,phone
        },{merge:true});
        helloName.textContent="Hi, "+(name||"User");
        profileMsg.style.color="green"; profileMsg.textContent="Profile saved.";
      }catch(e){ profileMsg.style.color="red"; profileMsg.textContent=e.message; }
      saveProfileBtn.disabled=false;
    };

    // ===== Change Password
    changePwdBtn.onclick=async ()=>{
      profileMsg.textContent="";
      changePwdBtn.disabled=true;
      try{
        await sendPasswordResetEmail(auth,currentUser.email);
        profileMsg.style.color="green"; profileMsg.textContent="Reset email sent!";
      }catch(e){ profileMsg.style.color="red"; profileMsg.textContent=e.message; }
      changePwdBtn.disabled=false;
    };

    // ===== Logout
    logoutBtn.onclick=()=>signOut(auth);

    // ===== Claim Points
    claimBtn.onclick=async ()=>{
      claimMsg.textContent="";
      claimBtn.disabled=true;
      const billNo=billNo.value.trim();
      const amount=parseFloat(billAmount.value);
      if(!billNo||isNaN(amount)||amount<=0){showClaimError("Enter valid bill/amount");claimBtn.disabled=false;return;}

      try{
        const bRef=doc(db,"bills",billNo);
        const bSnap=await getDoc(bRef);

        if(bSnap.exists()){
          const b=bSnap.data();
          if(b.claimedBy){ showClaimError("Already claimed."); claimBtn.disabled=false; return; }
          if(amount!==Number(b.amount)){ showClaimError(`Mismatch. Bill is â‚¹${b.amount}`); claimBtn.disabled=false; return; }

          const points=Math.floor(amount*0.01);
          const uRef=doc(db,"users",currentUser.uid);

          await runTransaction(db,async(tx)=>{
            const uSnap=await tx.get(uRef);
            const cur=uSnap.exists()?uSnap.data().points||0:0;
            tx.update(uRef,{points:cur+points});
            tx.set(doc(collection(uRef,"claims")),{
              billNo,amount,points,createdAt:serverTimestamp()
            });
            tx.update(bRef,{claimedBy:currentUser.uid,claimedAt:serverTimestamp()});
          });

          claimMsg.style.color="green"; claimMsg.textContent=`Success! +${points} points.`;
          billNo.value=""; billAmount.value="";
          loadProfileAndPoints(currentUser.uid);
        }else{
          await addDoc(collection(db,"admin_inbox"),{
            type:"bill_not_found",billNo,amount,
            userId:currentUser.uid,userEmail:currentUser.email,createdAt:serverTimestamp()
          });
          claimMsg.style.color="orange"; claimMsg.textContent="Bill not found. Sent to admin.";
        }
      }catch(e){ showClaimError(e.message); }
      claimBtn.disabled=false;
    };

    function showClaimError(msg){ claimMsg.style.color="red"; claimMsg.textContent=msg; }

    // ===== My Claims
    function subscribeClaims(uid){
      const q=query(collection(db,"users",uid,"claims"),orderBy("createdAt","desc"));
      onSnapshot(q,(snap)=>{
        claimsTable.innerHTML="";
        snap.forEach(docSnap=>{
          const c=docSnap.data();
          const date=c.createdAt?c.createdAt.toDate().toLocaleString():"-";
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${c.billNo}</td><td>â‚¹${c.amount}</td><td>${c.points}</td><td>${date}</td>`;
          claimsTable.appendChild(tr);
        });
      });
    }

    // ===== Notifications
    function subscribeNotifications(){
      const q=query(collection(db,"notifications"),orderBy("createdAt","desc"));
      onSnapshot(q,(snap)=>{
        userNotifList.innerHTML="";
        snap.forEach(d=>{
          const n=d.data();
          const date=n.createdAt?n.createdAt.toDate().toLocaleString():"-";
          const li=document.createElement("li");
          li.textContent=`[${date}] ${n.message}`;
          userNotifList.appendChild(li);
        });
      });
    }
  </script>
</body>
</html>
